# 天穹安防系统 - 开发指南

## 项目概述

本文档为开发人员提供天穹安防系统的开发指南，包括项目架构、开发环境设置、编码规范和贡献流程等内容。

## 项目架构

### 整体架构

- **前端**: 纯客户端JavaScript应用
- **后端交互**: 通过RESTful API与后端服务通信
- **数据存储**: 浏览器本地存储(localStorage)和API数据
- **核心模块**:
  - 应用核心(app.js)
  - 性能监控(performance_monitor.js)
  - 入侵检测系统(ids/)
  - 安全审计功能
  - 测试框架(test/)

### 目录结构

```
xuan-guang-security-gpt/
├── web/                    # 前端应用目录
│   ├── app.js              # 主应用逻辑
│   ├── bg.js               # 背景处理脚本
│   ├── performance_monitor.js # 性能监控模块
│   ├── index.html          # 主页面
│   ├── style.css           # 样式文件
│   ├── ids/                # 入侵检测系统模块
│   │   ├── InvasionDetector.js # 入侵检测核心
│   │   └── test/           # IDS测试文件
│   └── test/               # 测试框架
│       ├── main_test_runner.js # 主测试运行器
│       └── test_runner.html    # 测试运行器页面
├── docs/                   # 文档目录
├── .github/workflows/      # GitHub Actions工作流
└── README.md               # 项目说明文档
```

## 开发环境设置

### 环境要求

- **浏览器**: 现代浏览器(Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)
- **开发工具**:
  - 文本编辑器(VS Code推荐)
  - 浏览器开发者工具
  - Git版本控制
- **可选工具**:
  - Node.js环境(用于静态服务器)
  - Python(用于简单HTTP服务器)

### 开发环境配置

1. **克隆项目**
   ```bash
   git clone [repository-url]
   cd xuan-guang-security-gpt
   ```

2. **启动开发服务器**
   ```bash
   # 方法1: 使用Python HTTP服务器
   cd web
   python -m http.server 8000
   
   # 方法2: 使用Node.js(如果已安装)
   cd web
   npx http-server -p 8000
   ```

3. **访问开发环境**
   - 浏览器打开: `http://localhost:8000`

4. **开发工具配置**
   - 推荐使用VS Code的ESLint和Prettier扩展
   - 配置自动格式化和代码检查

## 编码规范

### JavaScript编码规范

1. **代码风格**
   - 使用2空格缩进
   - 语句末尾使用分号
   - 使用驼峰命名法
   - 常量使用全大写加下划线

2. **变量声明**
   - 使用`const`声明常量
   - 使用`let`声明可变变量
   - 避免使用`var`

3. **函数定义**
   - 使用箭头函数表达简洁逻辑
   - 对于复杂函数，使用函数声明
   - 保持函数简洁，单一职责

4. **错误处理**
   - 使用try/catch处理可能的异常
   - 提供有意义的错误消息
   - 适当记录错误信息

5. **代码注释**
   - 关键逻辑添加注释
   - 函数提供JSDoc注释
   - 复杂算法解释其工作原理

### HTML/CSS规范

1. **HTML结构**
   - 使用语义化标签
   - 缩进清晰
   - 避免内联样式

2. **CSS命名**
   - 使用BEM命名约定
   - 保持样式模块化
   - 避免过度嵌套

### 安全编码实践

1. **输入验证**
   - 所有用户输入必须验证
   - 避免直接使用用户输入拼接HTML
   - 实施内容安全策略

2. **数据处理**
   - 敏感数据加密存储
   - API密钥保护
   - 避免在日志中记录敏感信息

## 核心模块开发指南

### 应用核心(app.js)

1. **主要功能**
   - 应用初始化
   - 路由管理
   - API通信
   - 用户认证
   - 状态管理

2. **扩展指南**
   - 添加新API方法时，遵循现有模式
   - 新功能应集成到状态管理中
   - 确保与现有功能兼容

### 性能监控模块

1. **功能概述**
   - 内存使用监控
   - 网络请求性能跟踪
   - 渲染性能监控
   - 自动性能优化

2. **扩展方法**
   - 添加新的性能指标收集
   - 扩展性能报告生成
   - 实现新的自动优化策略

### 入侵检测系统

1. **核心组件**
   - InvasionDetector.js: 检测引擎
   - 规则配置
   - 告警机制

2. **开发流程**
   - 编写新的检测规则
   - 实现检测算法
   - 添加单元测试
   - 集成到现有系统

## 测试指南

### 测试框架

1. **测试类型**
   - 单元测试: 测试单个功能模块
   - 集成测试: 测试模块间交互
   - 性能测试: 测试系统性能
   - 安全测试: 测试安全功能

2. **运行测试**
   - 通过测试运行器页面: `/test/test_runner.html`
   - 使用CI/CD流程自动运行测试

3. **编写测试**
   - 为新功能编写测试用例
   - 测试覆盖正常、边界和错误情况
   - 使用断言验证预期行为

### 测试最佳实践

1. **测试原则**
   - 每个测试应专注于单一功能
   - 测试应快速执行
   - 测试应具有可重复性
   - 测试应提供清晰的失败信息

2. **测试覆盖率**
   - 关键功能应达到高覆盖率
   - 至少测试核心业务逻辑
   - 定期审查测试覆盖率

## API集成

### API接口约定

1. **请求格式**
   - 使用fetch API进行请求
   - 标准请求头设置
   - JSON格式数据交换

2. **错误处理**
   - 统一的错误响应格式
   - 错误状态码处理
   - 重试机制实现

3. **缓存策略**
   - 使用requestCache对象管理缓存
   - 合理设置缓存过期时间
   - 缓存失效处理

### 代理配置

1. **代理设置**
   - 通过UI配置代理服务器
   - 支持HTTP/HTTPS/SOCKS5代理
   - 认证代理支持

2. **代理使用**
   - API请求自动使用配置的代理
   - 代理连接状态监控
   - 代理失败处理

## 调试指南

### 浏览器调试

1. **开发工具使用**
   - 控制台日志分析
   - 网络请求监控
   - 断点调试
   - 性能分析

2. **调试技巧**
   - 使用console.log()标记执行流程
   - 使用debugger语句设置断点
   - 利用条件断点精确定位问题
   - 监控内存使用和泄漏

### 常见问题排查

1. **API连接问题**
   - 检查网络连接
   - 验证API配置
   - 查看CORS错误

2. **渲染问题**
   - 检查DOM结构
   - 分析CSS样式冲突
   - 调试JavaScript事件处理

3. **性能问题**
   - 使用Performance面板分析
   - 检查内存使用峰值
   - 识别长时间运行的任务

## 持续集成与部署

### CI/CD流程

1. **GitHub Actions配置**
   - 测试作业: 运行单元测试和安全扫描
   - 构建作业: 构建和优化项目
   - 部署作业: 部署到测试环境
   - 发布作业: 发布生产版本

2. **触发条件**
   - 代码提交到主分支
   - Pull Request创建
   - 手动触发

3. **环境变量**
   - 测试环境配置
   - 生产环境配置
   - 安全凭证管理

### 部署流程

1. **测试环境部署**
   - 自动部署到测试服务器
   - 运行集成测试
   - 性能测试验证

2. **生产环境部署**
   - 代码审查
   - 安全扫描
   - 分阶段部署
   - 部署后验证

## 贡献流程

### 贡献指南

1. **代码贡献步骤**
   - Fork项目仓库
   - 创建特性分支
   - 实现功能或修复
   - 编写测试
   - 提交Pull Request

2. **代码审查**
   - 遵循编码规范
   - 提供清晰的变更描述
   - 响应审查反馈
   - 更新相关文档

### 提交规范

1. **提交消息格式**
   - 类型前缀: feat, fix, docs, style, refactor, test, chore
   - 简短描述(不超过50字符)
   - 详细描述(可选，72字符换行)

2. **示例**
   ```
   feat: 添加性能监控模块
   
   实现了内存使用监控、网络请求性能跟踪和
   渲染性能分析功能，提高系统可观测性。
   ```

## 文档维护

1. **文档更新**
   - 功能变更时同步更新文档
   - 保持文档与代码一致
   - 定期审查文档准确性

2. **文档格式**
   - 使用Markdown格式
   - 清晰的层次结构
   - 适当的示例和图表

## 扩展系统

### 添加新功能

1. **功能规划**
   - 评估对现有系统的影响
   - 设计API和数据结构
   - 规划UI组件

2. **实现步骤**
   - 创建新的功能模块
   - 集成到主应用
   - 添加配置选项
   - 实现持久化存储

### 添加新视图

1. **视图创建**
   - 在HTML中定义视图结构
   - 添加路由处理
   - 实现视图逻辑
   - 集成到导航菜单

2. **视图约定**
   - 遵循现有视图结构
   - 使用统一的样式
   - 实现响应式设计

## 性能优化指南

### 前端优化

1. **代码优化**
   - 减少不必要的DOM操作
   - 优化JavaScript执行
   - 使用事件委托
   - 避免阻塞渲染

2. **资源优化**
   - 最小化CSS和JavaScript
   - 延迟加载非关键资源
   - 优化图片和资源缓存

### 网络优化

1. **API优化**
   - 减少API请求次数
   - 使用缓存策略
   - 实现请求合并
   - 优化请求参数

2. **数据传输**
   - 压缩数据传输
   - 使用适当的数据格式
   - 实施分页和增量加载

## 安全开发

### 安全检查清单

1. **输入验证**
   - [ ] 所有用户输入都经过验证
   - [ ] 使用参数化查询
   - [ ] 防止XSS攻击

2. **认证与授权**
   - [ ] 安全的会话管理
   - [ ] 适当的访问控制
   - [ ] 敏感操作的二次验证

3. **数据保护**
   - [ ] 敏感数据加密
   - [ ] 安全的存储方式
   - [ ] 适当的错误处理

### 安全测试

1. **测试类型**
   - 静态代码分析
   - 动态应用安全测试
   - 渗透测试
   - 依赖检查

2. **常见漏洞**
   - SQL注入
   - 跨站脚本(XSS)
   - 跨站请求伪造(CSRF)
   - 不安全的直接对象引用

## 附录

### 开发工具推荐

- **编辑器**: VS Code
- **调试**: Chrome DevTools
- **性能分析**: Lighthouse
- **安全扫描**: OWASP ZAP

### 资源链接

- JavaScript文档: [MDN Web Docs](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript)
- 安全最佳实践: [OWASP](https://owasp.org/www-project-top-ten/)
- 性能优化: [Web Vitals](https://web.dev/vitals/)

---

*本文档由天穹安防系统开发团队编写，最后更新时间: 2023年12月*
*文档应随项目发展不断更新和完善*